<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003"
         DefaultTargets="Merge"
         ToolsVersion="3.5">
  <Import Project="..\Build\CommonImports.proj"/>
  <UsingTask Condition="'$(TEAMCITY_VERSION)'!=''" TaskName="NUnitTeamCity" AssemblyFile="$(teamcity_dotnet_nunitlauncher_msbuild_task)" />

  <PropertyGroup>
    <Configuration Condition="'$(Configuration)'==''">Release</Configuration>
    <Platform Condition="'$(Platform)'==''">x86</Platform>
  </PropertyGroup>


  <Target Name="Init">
    <PropertyGroup>
      <PlatformDir Condition="'$(Platform)'=='Any CPU'">AnyCPU</PlatformDir> <!-- "Any CPU" is special - it gets turned into "AnyCPU" by MSBuild at some point, including the default directories used when compiling from Visual Studio. -->
      <PlatformDir Condition="'$(Platform)'!='Any CPU'">$(Platform)</PlatformDir>
      <OutputPathTemp>$(BuildsPath)\~Temp\$(ProjectName)\$(Configuration)-$(PlatformDir)-Temp</OutputPathTemp>
      <OutputPathRaw>$(BuildsPath)\$(ProjectName)\$(Configuration)-$(PlatformDir)-Raw</OutputPathRaw>
      <OutputPathMerged>$(BuildsPath)\$(ProjectName)\$(Configuration)-$(PlatformDir)-Merged</OutputPathMerged>
      <OutputPathDeployment>$(BuildsPath)\$(ProjectName)\$(Configuration)-$(PlatformDir)-Deployment</OutputPathDeployment>
    </PropertyGroup>
    <ConvertToAbsolutePath Paths="$(OutputPathTemp)"><Output TaskParameter="AbsolutePaths" PropertyName="OutputPathTemp"/></ConvertToAbsolutePath>
    <ConvertToAbsolutePath Paths="$(OutputPathRaw)"><Output TaskParameter="AbsolutePaths" PropertyName="OutputPathRaw"/></ConvertToAbsolutePath>
    <ConvertToAbsolutePath Paths="$(OutputPathMerged)"><Output TaskParameter="AbsolutePaths" PropertyName="OutputPathMerged"/></ConvertToAbsolutePath>
    <ConvertToAbsolutePath Paths="$(OutputPathDeployment)"><Output TaskParameter="AbsolutePaths" PropertyName="OutputPathDeployment"/></ConvertToAbsolutePath>
    <Message Text='Output paths:'/>
    <Message Text='  temp: $(OutputPathTemp)'/>
    <Message Text='  raw: $(OutputPathRaw)'/>
    <Message Text='  merged: $(OutputPathMerged)'/>
    <Message Text='  deployment: $(OutputPathDeployment)'/>
  </Target>


  <Target Name="Build" DependsOnTargets="Init">
    <MSBuild Projects="$(ProjectName).sln" Targets="Rebuild"
             Properties="Configuration=$(Configuration);Platform=$(Platform);OutputPath=$(OutputPathRaw)\;IntermediateOutputPath=$(OutputPathTemp)\;BaseIntermediateOutputPath=$(OutputPathTemp)\"/>
  </Target>


  <Target Name="Merge" DependsOnTargets="Build">
    <ItemGroup>
      <MergeFilesAndEtc Include="$(OutputPathRaw)\RT.SqlChainTests.*"/>
      <MergeFilesAndEtc Include="$(OutputPathRaw)\RT.SqlChain.*"/>
      <MergeFilesAndEtc Include="$(OutputPathRaw)\RT.Util.*"/>
      <MergeFilesAndEtc Include="$(OutputPathRaw)\NUnitDirect.*"/>
      <MergeFilesAndEtc Include="$(OutputPathRaw)\System.Data.SQLite.*"/>
      <MergeFilesAndEtc Include="$(OutputPathRaw)\IQToolkit.*"/>
    </ItemGroup>

    <RegexMatch Input="@(MergeFilesAndEtc)" Expression="(\.exe$)|(\.dll$)">
      <Output TaskParameter="Output" ItemName="MergeFiles"/>
    </RegexMatch>
    <ItemGroup>
      <UnmergedFiles Include="$(OutputPathRaw)\**" Exclude="@(MergeFilesAndEtc)"/>
    </ItemGroup>
    <Copy SourceFiles="@(UnmergedFiles)" DestinationFolder="$(OutputPathMerged)\%(RecursiveDir)"/>
    <MakeDir Directories="$(OutputPathMerged)"/>
    <Exec Command='"$(ILMerge)" "/out:$(OutputPathMerged)\$(ProjectName).exe" "@(MergeFiles, &apos;" "&apos;)"'/>
  </Target>


  <Target Name="Test" DependsOnTargets="Merge">
    <NUnitTeamCity Platform="x86" NUnitVersion="NUnit-2.5.3" Assemblies="$(OutputPathMerged)\$(ProjectName).exe"/>
  </Target>

</Project>